// chatgpt generated data table because i am lazy
// BEWARE OF ERRORS
const c128 = [
  { a: " ", b: " ", c: "00", widths: "212222" }, // 0
  { a: "!", b: "!", c: "01", widths: "222122" }, // 1
  { a: "\"", b: "\"", c: "02", widths: "222221" }, // 2
  { a: "#", b: "#", c: "03", widths: "121223" }, // 3
  { a: "$", b: "$", c: "04", widths: "121322" }, // 4
  { a: "%", b: "%", c: "05", widths: "131222" }, // 5
  { a: "&", b: "&", c: "06", widths: "122213" }, // 6
  { a: "'", b: "'", c: "07", widths: "122312" }, // 7
  { a: "(", b: "(", c: "08", widths: "132212" }, // 8
  { a: ")", b: ")", c: "09", widths: "221213" }, // 9
  { a: "*", b: "*", c: "10", widths: "221312" }, // 10
  { a: "+", b: "+", c: "11", widths: "231212" }, // 11
  { a: ",", b: ",", c: "12", widths: "112232" }, // 12
  { a: "-", b: "-", c: "13", widths: "122132" }, // 13
  { a: ".", b: ".", c: "14", widths: "122231" }, // 14
  { a: "/", b: "/", c: "15", widths: "113222" }, // 15
  { a: "0", b: "0", c: "16", widths: "123122" }, // 16
  { a: "1", b: "1", c: "17", widths: "123221" }, // 17
  { a: "2", b: "2", c: "18", widths: "223211" }, // 18
  { a: "3", b: "3", c: "19", widths: "221132" }, // 19
  { a: "4", b: "4", c: "20", widths: "221231" }, // 20
  { a: "5", b: "5", c: "21", widths: "213212" }, // 21
  { a: "6", b: "6", c: "22", widths: "223112" }, // 22
  { a: "7", b: "7", c: "23", widths: "312131" }, // 23
  { a: "8", b: "8", c: "24", widths: "311222" }, // 24
  { a: "9", b: "9", c: "25", widths: "321122" }, // 25
  { a: ":", b: ":", c: "26", widths: "321221" }, // 26
  { a: ";", b: ";", c: "27", widths: "312212" }, // 27
  { a: "<", b: "<", c: "28", widths: "322112" }, // 28
  { a: "=", b: "=", c: "29", widths: "322211" }, // 29
  { a: ">", b: ">", c: "30", widths: "212123" }, // 30
  { a: "?", b: "?", c: "31", widths: "212321" }, // 31
  { a: "@", b: "@", c: "32", widths: "232121" }, // 32
  { a: "A", b: "A", c: "33", widths: "111323" }, // 33
  { a: "B", b: "B", c: "34", widths: "131123" }, // 34
  { a: "C", b: "C", c: "35", widths: "131321" }, // 35
  { a: "D", b: "D", c: "36", widths: "112313" }, // 36
  { a: "E", b: "E", c: "37", widths: "132113" }, // 37
  { a: "F", b: "F", c: "38", widths: "132311" }, // 38
  { a: "G", b: "G", c: "39", widths: "211313" }, // 39
  { a: "H", b: "H", c: "40", widths: "231113" }, // 40
  { a: "I", b: "I", c: "41", widths: "231311" }, // 41
  { a: "J", b: "J", c: "42", widths: "112133" }, // 42
  { a: "K", b: "K", c: "43", widths: "112331" }, // 43
  { a: "L", b: "L", c: "44", widths: "132131" }, // 44
  { a: "M", b: "M", c: "45", widths: "113123" }, // 45
  { a: "N", b: "N", c: "46", widths: "113321" }, // 46
  { a: "O", b: "O", c: "47", widths: "133121" }, // 47
  { a: "P", b: "P", c: "48", widths: "313121" }, // 48
  { a: "Q", b: "Q", c: "49", widths: "211331" }, // 49
  { a: "R", b: "R", c: "50", widths: "231131" }, // 50
  { a: "S", b: "S", c: "51", widths: "213113" }, // 51
  { a: "T", b: "T", c: "52", widths: "213311" }, // 52
  { a: "U", b: "U", c: "53", widths: "213131" }, // 53
  { a: "V", b: "V", c: "54", widths: "311123" }, // 54
  { a: "W", b: "W", c: "55", widths: "311321" }, // 55
  { a: "X", b: "X", c: "56", widths: "331121" }, // 56
  { a: "Y", b: "Y", c: "57", widths: "312113" }, // 57
  { a: "Z", b: "Z", c: "58", widths: "312311" }, // 58
  { a: "[", b: "[", c: "59", widths: "332111" }, // 59
  { a: "\\", b: "\\", c: "60", widths: "314111" }, // 60
  { a: "]", b: "]", c: "61", widths: "221411" }, // 61
  { a: "^", b: "^", c: "62", widths: "431111" }, // 62
  { a: "_", b: "_", c: "63", widths: "111224" }, // 63
  { a: "\u0000", b: "`", c: "64", widths: "111422" }, // 64: NUL
  { a: "\u0001", b: "a", c: "65", widths: "121124" }, // 65: SOH
  { a: "\u0002", b: "b", c: "66", widths: "121421" }, // 66: STX
  { a: "\u0003", b: "c", c: "67", widths: "141122" }, // 67: ETX
  { a: "\u0004", b: "d", c: "68", widths: "141221" }, // 68: EOT
  { a: "\u0005", b: "e", c: "69", widths: "112214" }, // 69: ENQ
  { a: "\u0006", b: "f", c: "70", widths: "112412" }, // 70: ACK
  { a: "\u0007", b: "g", c: "71", widths: "122114" }, // 71: BEL
  { a: "\u0008", b: "h", c: "72", widths: "122411" }, // 72: BS
  { a: "\u0009", b: "i", c: "73", widths: "142112" }, // 73: HT
  { a: "\u000A", b: "j", c: "74", widths: "142211" }, // 74: LF
  { a: "\u000B", b: "k", c: "75", widths: "241211" }, // 75: VT
  { a: "\u000C", b: "l", c: "76", widths: "221114" }, // 76: FF
  { a: "\u000D", b: "m", c: "77", widths: "413111" }, // 77: CR
  { a: "\u000E", b: "n", c: "78", widths: "241112" }, // 78: SO
  { a: "\u000F", b: "o", c: "79", widths: "134111" }, // 79: SI
  { a: "\u0010", b: "p", c: "80", widths: "111242" }, // 80: DLE
  { a: "\u0011", b: "q", c: "81", widths: "121142" }, // 81: DC1
  { a: "\u0012", b: "r", c: "82", widths: "121241" }, // 82: DC2
  { a: "\u0013", b: "s", c: "83", widths: "114212" }, // 83: DC3
  { a: "\u0014", b: "t", c: "84", widths: "124112" }, // 84: DC4
  { a: "\u0015", b: "u", c: "85", widths: "124211" }, // 85: NAK
  { a: "\u0016", b: "v", c: "86", widths: "411212" }, // 86: SYN
  { a: "\u0017", b: "w", c: "87", widths: "421112" }, // 87: ETB
  { a: "\u0018", b: "x", c: "88", widths: "421211" }, // 88: CAN
  { a: "\u0019", b: "y", c: "89", widths: "212141" }, // 89: EM
  { a: "\u001A", b: "z", c: "90", widths: "214121" }, // 90: SUB
  { a: "\u001B", b: "{", c: "91", widths: "412121" }, // 91: ESC
  { a: "\u001C", b: "|", c: "92", widths: "111143" }, // 92: FS
  { a: "\u001D", b: "}", c: "93", widths: "111341" }, // 93: GS
  { a: "\u001E", b: "~", c: "94", widths: "131141" }, // 94: RS
  { a: "\u001F", b: "\u007F", c: "95", widths: "114113" }, // 95: US
  { a: "FNC3", b: "FNC3", c: "96", widths: "114311" }, // 96
  { a: "FNC2", b: "FNC2", c: "97", widths: "411113" }, // 97
  { a: "sB", b: "sA", c: "98", widths: "411311" }, // 98: Shift B/A
  { a: "cC", b: "cC", c: "99", widths: "113141" }, // 99: Code C
  { a: "cB", b: "FNC4", c: "cB", widths: "114131" }, // 100: Code B / FNC4
  { a: "FNC4", b: "cA", c: "cA", widths: "311141" }, // 101: FNC4 / Code A
  { a: "FNC1", b: "FNC1", c: "FNC1", widths: "411131" }, // 102
  { a: "scA", b: "scA", c: "scA", widths: "211412" }, // 103: Start Code A
  { a: "scB", b: "scB", c: "scB", widths: "211214" }, // 104: Start Code B
  { a: "scC", b: "scC", c: "scC", widths: "211232" }, // 105: Start Code C
  { a: "STOP", b: "STOP", c: "STOP", widths: "233111" } // 106: Stop
];

function widthToCode() {
  const cMap = {};
  for (let i=0; i<c128.length; i++) {
    cMap[c128[i].widths] = i;
  }
  return cMap;
}

const c128w = widthToCode();

function interpretCode(widths) {
  if (widths === null) return null;
  
  // check width size
  if (widths.length % 6 !== 1) return {
    error: "invalid width size"
  };
  
  // check bit size
  let sum = 0;
  for (let i of widths) {
    sum += i;
  }
  if (sum % 11 !== 2) return {
    error: "invalid bit size"
  };
  
  // reverse upside-down barcodes
  for (let i=0; i<6; i++) {
    // if reverse stop detected
    if (widths[i] === [2, 1, 1, 1, 3, 3][i]) {
      widths.reverse(); // unreverse widths
    }
  }
  
  // indexize barcode data
  const indexized = [];
  for (let i=0; i<widths.length-1; i+=6) {
    // current widths
    const cWidth = widths.slice(i, i+6).join("");
    
    // get index
    const index = c128w[cWidth];
    
    // undefined index
    if (index === undefined) return {
      error: "undefined index"
    };
    
    indexized.push(index);
  }
  
  // calculate checksum
  let checksum = indexized[0];
  for (let i=1; i<indexized.length-2; i++) {
    checksum += indexized[i] * i;
  }
  checksum %= 103;
  
  // verify checksum
  if (checksum !== indexized[indexized.length-2]) return {
    error: "invalid checksum",
    calculatedChecksum: checksum,
    listedChecksum: indexized[indexized.length-2],
    indexized: indexized
  };
  
  // actually interpret the code now
  let mode = "c"; // default to mode c bc why not
  let shift = null;
  let text = "";
  for (let i=0; i<indexized.length-2; i++) {
    // value of current block
    const value = indexized[i];
    
    // select current action
    let current;
    if (shift === null) {
      current = c128[value][mode];
    } else {
      current = c128[value][shift];
      shift = null;
    }
    
    // console.log(i, current, mode);
    switch (current) {
      case "FNC1": // lazy
        text += "[FNC1]";
        break;
      case "FNC2": // lazy
        text += "[FNC2]";
        break;
      case "FNC3": // lazy
        text += "[FNC3]";
        break;
      case "FNC4":
        // do later
        break;
      case "cA":
        mode = "a";
        break;
      case "cB":
        mode = "b";
        break;
      case "cC":
        mode = "c";
        break;
      case "scA":
        mode = "a";
        break;
      case "scB":
        mode = "b";
        break;
      case "scC":
        mode = "c";
        break;
      case "sA":
        shift = "a";
        break;
      case "sB":
        shift = "b";
        break;
      case "sC":
        shift = "c";
        break;
      /*
      case "STOP":
        // not needed because size predetermined
        break;
      */
      default:
        text += current;
        break;
    }
  }
  
  return {
    widths: widths,
    indexized: indexized,
    data: text
  };
}

export { interpretCode };